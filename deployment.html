

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Deployment &mdash; workflow-manager  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Future" href="future.html" />
    <link rel="prev" title="Examples" href="examples.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> workflow-manager
          

          
            
            <img src="_static/abi-vc-rgb.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflow_components/index.html">Workflow components</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#docker">Docker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#build-the-workflow-manager-docker-image">1. Build the workflow-manager docker image</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-the-docker-image">2. Run the docker image</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stop-a-docker-container">Stop a docker container</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#singularity">Singularity</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#build-the-singularity-image-based-on-the-pre-built-docker-image">1. Build the Singularity image based on the pre-built docker image</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-the-singularity-image">2. Run the Singularity image</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="future.html">Future</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="unit_testing.html">Unit testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing_to_documentation.html">Contributing to documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributors.html">Contributors</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">workflow-manager</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Deployment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/deployment.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="deployment">
<h1>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h1>
<p>Here is a complete example on how to setup and run a simple workflow via container-based approach.</p>
<blockquote>
<div><ul class="simple">
<li><p>Run in <a class="reference internal" href="#docker"><span class="std std-ref">Docker</span></a></p></li>
<li><p>Run in <a class="reference internal" href="#singularity"><span class="std std-ref">Singularity</span></a></p></li>
</ul>
</div></blockquote>
<div class="section" id="docker">
<span id="id1"></span><h2>Docker<a class="headerlink" href="#docker" title="Permalink to this headline">¶</a></h2>
<div class="section" id="build-the-workflow-manager-docker-image">
<span id="id2"></span><h3>1. Build the workflow-manager docker image<a class="headerlink" href="#build-the-workflow-manager-docker-image" title="Permalink to this headline">¶</a></h3>
<p>Build the docker image from <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> in <code class="docutils literal notranslate"><span class="pre">/path/to/workflow-manager/docker/ubuntu</span></code></p>
<ol class="arabic">
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">/path/to/workflow-manager</span></code></p></li>
<li><p>Run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo docker build -f ./docker/ubuntu/Dockerfile --tag workflow-manager .
</pre></div>
</div>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>FYI, below is the dockerfile we just used.</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">ARG</span> <span class="nv">CODE_VERSION</span><span class="o">=</span><span class="m">18</span>.04
<span class="k">FROM</span> <span class="s">ubuntu:${CODE_VERSION}</span>

<span class="k">USER</span><span class="s"> root</span>

<span class="c"># Environment variables</span>
<span class="k">ENV</span> MODULES_DIR /modules
<span class="k">ENV</span> SCRIPTS /scripts
<span class="k">ENV</span> PROJECT_NAME wm_project
<span class="k">ENV</span> PROJECT_ROOT /<span class="nv">$PROJECT_NAME</span>
<span class="k">ENV</span> DICOM_NODE /dcmtk/received
<span class="k">ENV</span> EXAMPLES /examples
<span class="k">ENV</span> RESULTS /results
<span class="k">ENV</span> RESOURCES /resources

<span class="c"># Make dirs</span>
<span class="k">RUN</span> mkdir -p <span class="nv">$MODULES_DIR</span>
<span class="k">RUN</span> mkdir -p <span class="nv">$SCRIPTS</span>
<span class="k">RUN</span> mkdir -p <span class="nv">$PROJECT_ROOT</span>
<span class="k">RUN</span> mkdir -p <span class="nv">$DICOM_NODE</span>
<span class="k">RUN</span> mkdir -p /mongodb/data/db
<span class="k">RUN</span> mkdir -p <span class="nv">$RESULTS</span>
<span class="k">RUN</span> mkdir -p <span class="nv">$RESOURCES</span>

<span class="c"># Install system packages</span>
<span class="k">RUN</span> apt update
<span class="k">RUN</span> apt install -y dcmtk
<span class="k">RUN</span> apt install -y python3.6 build-essential python3.6-dev python3-pip
<span class="k">RUN</span> apt install -y mongodb-server python-pymongo python-psutil python-tables

<span class="c"># Copy files</span>
<span class="k">ADD</span> ./requirements.txt /requirements.txt
<span class="k">ADD</span> ./docker/ubuntu/entrypoint.sh /entrypoint.sh
<span class="k">COPY</span> ./docker/scripts <span class="nv">$SCRIPTS</span>
<span class="k">COPY</span> ./examples <span class="nv">$EXAMPLES</span>

<span class="c"># Copy the custom packages to python site-package</span>
<span class="k">COPY</span> ./workflow_manager <span class="nv">$MODULES_DIR</span>/workflow_manager
<span class="k">RUN</span> cp -R <span class="nv">$MODULES_DIR</span>/workflow_manager /usr/local/lib/python3.6/dist-packages

<span class="c"># Install Python dependencies</span>
<span class="k">RUN</span> python3 -m pip install --upgrade pip
<span class="k">RUN</span> python3 -m pip install --no-cache-dir -r /requirements.txt

<span class="k">WORKDIR</span><span class="s"> $DICOM_NODE</span>
<span class="k">CMD</span> /bin/bash /entrypoint.sh

<span class="c"># How to build the image</span>
<span class="c"># 1. navigate to /path/to/workflow-manager</span>
<span class="c"># 2. sudo docker build -f ./docker/ubuntu/Dockerfile --tag workflow-manager .</span>

<span class="c"># How to run the image</span>
<span class="c"># 1. Create the following folders at any localtion:</span>
<span class="c">#    - dicom_node</span>
<span class="c">#    - test_project</span>
<span class="c">#    - mongodb</span>
<span class="c">#    - results</span>
<span class="c"># 2. sudo docker run -p 8105:8105 -v /path/to/dicom_node:/dcmtk -v /path/to/test_project:/wm_project -v /path/to/mongodb:/mongodb/data/db -v /path/to/results:/results workflow-manager</span>

<span class="c"># Run example pipeline</span>
<span class="c"># - sudo docker run -it -e MODE=examples workflow-manager</span>
<span class="c"># OR</span>
<span class="c"># - sudo docker run -it -e MODE=examples -v /path/to/test_project:/wm_project -v /path/to/mongodb:/mongodb/data/db -v /path/to/results:/results workflow-manager</span>
<span class="c"># Where:</span>
<span class="c">#   - the environment variable RUN_EXAMPLES specify whether to run the example pipeline.</span>
<span class="c">#     TODO. design a way to run custom scripts/pipeline to the docker image: by passing a config txt file &amp; a resource folder (input data &amp; resources)</span>
<span class="c">#   - Can also do folder mapping to save data locally (everything in docker will be deleted once the container is deleted). Some important folders in the docker images:</span>
<span class="c">#       - /wm_project: the project root folder which contains three subfolders: 1. processes 2. scripts 3. workspaces</span>
<span class="c">#       - /mongodb/data/db: the mongoDB database</span>
<span class="c">#       - /results: the results folder can be used for storing the workflow results</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="run-the-docker-image">
<h3>2. Run the docker image<a class="headerlink" href="#run-the-docker-image" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>Run the example workflow</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo docker run -it -e <span class="nv">MODE</span><span class="o">=</span>examples workflow-manager
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The results will be saved in the <code class="docutils literal notranslate"><span class="pre">results</span></code> folder in the container we just launched using the docker run command.
We can also map a folder inside a container to a local folder by adding a -v (or –volume ) argument to the run command above.
For example, <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-it</span> <span class="pre">-e</span> <span class="pre">RUN_EXAMPLES=TRUE</span> <span class="pre">-v</span> <span class="pre">/path/to/results:/results</span> <span class="pre">workflow-manager</span></code></p>
</div>
<ol class="arabic simple">
<li><p>Stop the container. See <a class="reference internal" href="#stop-a-docker-container"><span class="std std-ref">Stop a docker container</span></a></p></li>
</ol>
</div></blockquote>
</li>
<li><p>Run a custom workflow (TODO)</p>
<blockquote>
<div><p>This docker image also allow you to run yor own workflow by passing the scripts, data and any resource the workflow will be using into the docker container.</p>
<ol class="arabic">
<li><p>Create a <code class="docutils literal notranslate"><span class="pre">resources</span></code> folder locally and put all the input resources inside the folder.
For example, you can create the following sub-folders to store your your resources.</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">./scripts</span></code>: folder which contains your custom scripts.</dt><dd><p>Note that the scripts need to be converted/written in the format that the the workflow-manager supports.
Please see this <a class="reference internal" href="workflow_components/script.html#example-script"><span class="std std-ref">Example Script</span></a> for reference.</p>
</dd>
</dl>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">./data</span></code>: folder where you put the input data</p></li>
</ul>
</li>
<li><p>Create a script <code class="docutils literal notranslate"><span class="pre">project_setup.py</span></code> to set up the workflow project and put it inside the resources folder.
Below is an example of the setup script.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">workflow_manager</span> <span class="k">as</span> <span class="nn">wm</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="n">project_name</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
   <span class="n">project_root</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

   <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
   <span class="n">P</span> <span class="o">=</span> <span class="n">wm</span><span class="o">.</span><span class="n">create_project</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="n">root</span><span class="p">)</span>

   <span class="n">P</span><span class="o">.</span><span class="n">import_script</span><span class="p">(</span><span class="s1">&#39;./scripts/script1.py&#39;</span><span class="p">)</span>
   <span class="n">P</span><span class="o">.</span><span class="n">import_script</span><span class="p">(</span><span class="s1">&#39;./scripts/script2.py&#39;</span><span class="p">)</span>
   <span class="n">P</span><span class="o">.</span><span class="n">import_script</span><span class="p">(</span><span class="s1">&#39;./scripts/script3.py&#39;</span><span class="p">)</span>

   <span class="n">script</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="s1">&#39;script1&#39;</span><span class="p">)</span>
   <span class="n">script_input_arguments</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;relativePathToInputData/pretend_data.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;send_dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;RESULTS&#39;</span><span class="p">)}</span>
   <span class="n">script</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">script_input_arguments</span><span class="p">)</span>

   <span class="n">wm</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">start_process_monitor</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">minutes_alive</span><span class="o">=</span><span class="mi">999</span><span class="p">,</span> <span class="n">sleep_time</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">total_cores</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Create the following folders to save the project, database and results locally.
In the next step, we will do folder mapping between local folders and the folders inside the container.
Otherwise, you will lose all the data once the container is terminated.</p>
<ul class="simple">
<li><p>project_folder/</p></li>
<li><p>database_folder/</p></li>
<li><p>result_folder/</p></li>
</ul>
</li>
<li><p>Run the docker image</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo docker run -v /path/to/resources:/resource -v /path/to/project_folder:/wm_project -v /path/to/database_folder:/mongodb/data/db -v /path/to/results:/results workflow-manager
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the custom workflow, the final results will not automatically sent to the results folder.
The results by default will just be save in the project workspace(s) depanding on how you set up your workflow.
E.g <code class="docutils literal notranslate"><span class="pre">/wm_project/workspaces/0003</span></code>
You can either A. Map your local results folder to a final workspace
or B. Send all the results from the project workspace(s) to the <code class="docutils literal notranslate"><span class="pre">/results</span></code> folder inside docker, then do a mapping between the local results folder and the results folder inside docker.</p>
</div>
</li>
<li><p>Stop the container. See <a class="reference internal" href="#stop-a-docker-container"><span class="std std-ref">Stop a docker container</span></a></p></li>
</ol>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="stop-a-docker-container">
<span id="id3"></span><h3>Stop a docker container<a class="headerlink" href="#stop-a-docker-container" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Get container id</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo docker ps
</pre></div>
</div>
</li>
<li><p>Stop and delete the container</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo docker rm -f &lt;container_id&gt;
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="singularity">
<span id="id4"></span><h2>Singularity<a class="headerlink" href="#singularity" title="Permalink to this headline">¶</a></h2>
<div class="section" id="build-the-singularity-image-based-on-the-pre-built-docker-image">
<h3>1. Build the Singularity image based on the pre-built docker image<a class="headerlink" href="#build-the-singularity-image-based-on-the-pre-built-docker-image" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>See <a class="reference internal" href="#build-the-workflow-manager-docker-image"><span class="std std-ref">1. Build the workflow-manager docker image</span></a> to build the docker image.</p></li>
<li><p>Save the docker image as a .tar file</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo docker save workflow-manager &gt; workflow-manager.tar
</pre></div>
</div>
</li>
<li><p>Build the Singularity image from the pre-built docker image</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>singularity build workflow-manager.sif docker-archive://workflow-manager.tar
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="run-the-singularity-image">
<h3>2. Run the Singularity image<a class="headerlink" href="#run-the-singularity-image" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">run</span></code> command is very similar to <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code>. Please have a look at the <a class="reference internal" href="#docker"><span class="std std-ref">Docker</span></a> section to get more ideas of how to run the example or a custom workflow.
For example, the docker <code class="docutils literal notranslate"><span class="pre">-v</span></code> argument needs to be replaced with the singularity <code class="docutils literal notranslate"><span class="pre">-B</span></code> when doing folder mapping.</p>
<ul>
<li><p>Run the example workflow</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>singularity run -shell --env <span class="nv">MODE</span><span class="o">=</span>examples workflow-manager
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Run a custom workflow</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>singularity run -B /path/to/resources:/resource -B /path/to/project_folder:/wm_project -B /path/to/database_folder:/mongodb/data/db -B /path/to/results:/results /path/to/workflow-manager.sif
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="future.html" class="btn btn-neutral float-right" title="Future" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="examples.html" class="btn btn-neutral float-left" title="Examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2012, Duane Malcolm, Thiranja Prasad Babarenda Gamage, Chinchien Lin.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>